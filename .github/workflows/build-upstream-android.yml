name: Android build from ZIP

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Lấy code repo của BẠN (trong đó có file CasioEmuAndroid-fixed.zip)
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2) Giải nén source Android từ file ZIP (đã sửa abiFilters)
      - name: Unzip Android source
        run: |
          mkdir -p src
          unzip -q CasioEmuAndroid-fixed.zip -d src
          echo "===== SRC CONTENTS ====="
          ls -R src

      # 3) Tìm thư mục project (nơi có settings.gradle)
      - name: Detect project dir
        id: proj
        run: |
          PROJECT_DIR=$(find src -maxdepth 3 -type f -name "settings.gradle" -print | head -n1 | xargs dirname)
          echo "Detected project dir: $PROJECT_DIR"
          if [ -z "$PROJECT_DIR" ]; then
            echo "Không tìm thấy settings.gradle trong src" >&2
            exit 1
          fi
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_OUTPUT

      # 4) Xoá local.properties để tránh sdk.dir trỏ sai máy
      - name: Remove local.properties
        run: |
          if [ -f "${{ steps.proj.outputs.PROJECT_DIR }}/local.properties" ]; then
            rm "${{ steps.proj.outputs.PROJECT_DIR }}/local.properties"
          fi

      # 5) Cài JDK giống repo gốc dùng Gradle
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 6) Cài Android SDK (giống style workflow repo gốc)
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # 7) Build APK release bằng gradlew trong project
      - name: Build release APK
        run: |
          cd "${{ steps.proj.outputs.PROJECT_DIR }}"
          chmod +x gradlew
          ./gradlew assembleRelease

      # 8) Upload file APK để tải về
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: ${{ steps.proj.outputs.PROJECT_DIR }}/app/build/outputs/apk/release/*.apk
