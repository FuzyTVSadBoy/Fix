name: Build NX-U8 Android

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Lấy code repo Fix (chỉ để chứa workflow, không có source chính)
      - name: Checkout this repo
        uses: actions/checkout@v4

      # Tải source NX-U8 từ release SourceTest và giải nén
      - name: Download and unzip source from release
        run: |
          mkdir -p src
          # Tải file Casio.zip trong release SourceTest
          curl -L \
            -o src/nxu8.zip \
            "https://github.com/FuzyTVSadBoy/Fix/releases/download/SourceTest/Casio.zip"

          # Giải nén vào thư mục src
          unzip -q src/nxu8.zip -d src

      # Tự động tìm thư mục có gradlew (gốc project Android)
      - name: Detect Android project directory
        id: detect
        run: |
          set -e
          ROOT=$(find src -maxdepth 4 -type f -name "gradlew" | head -n 1)
          if [ -z "$ROOT" ]; then
            echo "Không tìm được gradlew trong src/" >&2
            exit 1
          fi
          DIR=$(dirname "$ROOT")
          echo "project_dir=$DIR" >> "$GITHUB_OUTPUT"
          echo "Project dir: $DIR"

      # Tăng độ tương thích: hạ minSdk và thêm ABI 32-bit
      - name: Patch app/build.gradle for compatibility
        run: |
          set -e
          APP_GRADLE="${{ steps.detect.outputs.project_dir }}/app/build.gradle"
          echo "Patching $APP_GRADLE"

          # 1) Hạ minSdkVersion 24 -> 21 (nhiều máy Android cũ hơn cài được)
          sed -i 's/minSdkVersion 24/minSdkVersion 21/' "$APP_GRADLE"

          # 2) Thêm ABI armeabi-v7a (32-bit) bên cạnh arm64-v8a
          sed -i "s/abiFilters 'arm64-v8a'/abiFilters 'armeabi-v7a', 'arm64-v8a'/" "$APP_GRADLE"

          echo "==== app/build.gradle (đầu file) sau khi patch ===="
          sed -n '1,80p' "$APP_GRADLE"

      # Cài JDK 17 cho Gradle
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # Cho phép chạy gradlew
      - name: Make gradlew executable
        working-directory: ${{ steps.detect.outputs.project_dir }}
        run: chmod +x gradlew

      # Build APK bản release
      - name: Build release APK
        working-directory: ${{ steps.detect.outputs.project_dir }}
        run: ./gradlew assembleRelease

      # Upload file APK sau khi build xong
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: nxu8-release
          path: ${{ steps.detect.outputs.project_dir }}/app/build/outputs/apk/release/*.apk
